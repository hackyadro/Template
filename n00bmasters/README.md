# YADRO hackathon indoor beacon locator



## n00bmasters team

# Прошивка для BLE-сканера на ESP32-S3

Этот документ описывает, как настроить плату ESP32-S3 для сканирования BLE-маяков и отправки данных по MQTT.

## 1. Пререквизиты (Что нужно установить на компьютер)

Перед началом убедитесь, что у вас установлены:
- **Python 3.x:** [Официальный сайт Python](https://www.python.org/downloads/) (при установке на Windows, поставьте галочку "Add Python to PATH").
- **esptool и rshell:** Это инструменты для работы с платой. Устанавливаются одной командой в терминале (командной строке):
  ```bash
  pip install esptool rshell
  ```
  *На macOS может потребоваться `pip3` вместо `pip`.*

## 2. Прошивка MicroPython

На этом шаге мы установим на плату "операционную систему" MicroPython.

1.  **Скачайте прошивку:**
    - Перейдите по ссылке: [Прошивки для ESP32-S3](https://micropython.org/download/ESP32_GENERIC_S3/)
    - Скачайте последнюю **стабильную** версию `.bin` файла (например, `ESP32_GENERIC_S3-....bin`).

2.  **Найдите порт платы:**
    - Подключите плату к компьютеру.
    - **Windows:** Откройте "Диспетчер устройств", найдите плату в разделе "Порты (COM и LPT)". Имя будет `COM3`, `COM4` и т.д.
    - **macOS/Linux:** Откройте терминал и выполните команду `ls /dev/cu.*` (на Mac) или `ls /dev/ttyUSB*` (на Linux). Найдите имя вашего порта, например `/dev/cu.usbserial-XXXXX`.

3.  **Сотрите старую прошивку:**
    - Переведите плату в **режим загрузки**: зажмите кнопку `BOOT`, нажмите и отпустите `RESET`, затем отпустите `BOOT`.
    - Выполните в терминале команду, заменив `YOUR_PORT` на имя вашего порта:
      ```bash
      esptool.py --chip esp32s3 --port YOUR_PORT erase_flash
      ```

4.  **Запишите новую прошивку:**
    - **Снова** переведите плату в режим загрузки.
    - В терминале перейдите в папку, куда вы скачали `.bin` файл (обычно "Загрузки").
    - Выполните команду, подставив **ваш порт** и **имя вашего файла**:
      ```bash
      esptool.py --chip esp32s3 --port YOUR_PORT --baud 460800 write_flash -z 0 ИМЯ_СКАЧАННОГО_ФАЙЛА.bin
      ```
    - После завершения нажмите кнопку `RESET` на плате.

## 3. Установка библиотек

Для работы скрипта нужны библиотеки `neopixel` и `umqtt.simple`. Мы установим их с помощью специального скрипта-установщика.

1.  **Настройте `install_libs.py`:**
    - Откройте файл `install_libs.py`.
    - Впишите **ваши реальные** имя и пароль от Wi-Fi в переменные `WIFI_SSID` и `WIFI_PASS`.

2.  **Загрузите и запустите установщик:**
    - Скопируйте `install_libs.py` на плату под именем `main.py` командой в терминале:
      ```bash
      rshell -p YOUR_PORT cp install_libs.py /pyboard/main.py
      ```
    - Нажмите `RESET` на плате. Плата подключится к Wi-Fi (светодиод будет мигать желтым) и автоматически скачает все нужные библиотеки.
    - Следите за процессом в терминале через `tio` или `rshell repl`. После установки она напишет "Libraries installed successfully".

3.  **Удалите установщик:**
    - После успешной установки важно удалить `main.py` с платы, чтобы он не запускался каждый раз.
      ```bash
      rshell -p YOUR_PORT rm /pyboard/main.py
      ```

## 4. Загрузка основного кода

Теперь, когда плата готова, мы загрузим основной рабочий скрипт.

1.  **Настройте `main.py`:**
    - Откройте файл `main.py`.
    - Убедитесь, что переменные `WIFI_SSID`, `WIFI_PASS` и `MQTT_BROKER` установлены правильно.
    - **Найдите `NEOPIXEL_PIN`** и, если нужно, измените `48` на номер пина светодиода вашей платы.

2.  **Загрузите `main.py` на плату:**
    ```bash
    rshell -p YOUR_PORT cp main.py /pyboard/main.py
    ```

3.  **Перезагрузите плату (`RESET`).**

4.  **Поднимите контейнер с mosquitto, он находится в mosquitto/docker-compose.yml, с помощью docker-compose up -d**

5.  **установите requirements.txt с помощью pip install -r requirements.txt**

6.  **запустите src/app.py**


Устройство начнет работать.

## Легенда LED-сигналов

Светодиод на плате показывает текущее состояние устройства:

-   **Пульсирующий ЖЕЛТЫЙ:** Идет подключение к Wi-Fi или MQTT.
-   **Постоянный ЗЕЛЕНЫЙ:** Штатная работа. Wi-Fi и MQTT подключены, идет сканирование.
-   **Короткое мигание СИНЕГО:** Пакет данных успешно отправлен на сервер.
-   **Постоянный КРАСНЫЙ:** Ошибка. Нет подключения к Wi-Fi или MQTT. Устройство автоматически будет перезапущено.


